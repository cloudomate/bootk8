version: "3.8"

# ─────────────────────────────────────────────────────────────────
# bootstrap-hci Management Portal
#
# Usage:
#   docker compose up -d
#   open http://localhost:3000
#
# Put your CMP manifests in ./cmp/ before clicking "Deploy CMP".
# The portal manages the bootstrap container lifecycle via Docker socket.
# ─────────────────────────────────────────────────────────────────

services:

  portal:
    image: cr.imys.in/hci/portal:latest
    build:
      context: .
      dockerfile: Dockerfile.portal
    ports:
      - "3000:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock   # Docker socket to manage bootstrap container
      - hci-output:/output                           # Shared with bootstrap container (status, kubeconfig)
      - hci-config:/config                           # Shared with bootstrap container (cluster.yaml)
      - ./cmp:/cmp:ro                                # Your CMP manifests
    environment:
      - BOOTSTRAP_IMAGE=cr.imys.in/hci/bootk8:latest
      - OUTPUT_VOLUME=hci-output
      - CONFIG_VOLUME=hci-config
      - OUTPUT_DIR=/output
      - CONFIG_DIR=/config
    restart: unless-stopped

volumes:
  hci-output:
    name: hci-output   # pin exact name so the bootstrap container (launched via Docker API) uses the same volume
  hci-config:
    name: hci-config   # without 'name:', compose would prefix the project name (e.g. hci_hci-config)
