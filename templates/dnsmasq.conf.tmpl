# dnsmasq config — generated by bootstrap node
# Acts as DHCP proxy + TFTP + PXE boot server

# Disable DNS server
port=0

# Restrict to the bootstrap interface only — prevents conflicts with
# Docker, libvirt, or other dnsmasq instances on the same host.
interface=${BOOTSTRAP_IFACE}

# DHCP mode (set by generate-configs.sh):
#   Proxy mode  (real hardware): dhcp-range=<BOOTSTRAP_IP>,proxy
#               Only adds PXE boot options; existing DHCP server assigns IPs.
#   Full mode   (KVM lab):       dhcp-range=<start>,<end>,<mask>,<lease>
#               Acts as the sole DHCP server; assigns IPs from the range.
dhcp-range=${DNSMASQ_DHCP_RANGE}

# Static MAC→IP host reservations (full DHCP mode only, empty in proxy mode)
${DNSMASQ_DHCP_HOSTS}

# TFTP root for PXE bootloader delivery
enable-tftp
tftp-root=/var/lib/tftpboot

# For non-iPXE clients: serve iPXE bootloader first
dhcp-boot=undionly.kpxe,,${BOOTSTRAP_IP}

# For clients already running iPXE: serve our boot script directly
dhcp-match=set:ipxe,175
dhcp-boot=tag:ipxe,http://${BOOTSTRAP_IP}:8080/boot.ipxe

# Logging
log-dhcp
log-queries

# Increase lease time visibility
dhcp-lease-max=1000
