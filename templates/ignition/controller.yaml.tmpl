variant: flatcar
version: 1.0.0

passwd:
  users:
    - name: core
      ssh_authorized_keys:
${SSH_KEYS_YAML}
      groups:
        - sudo

storage:
  files:
    - path: /etc/modules-load.d/kubernetes.conf
      mode: 0644
      contents:
        inline: |
          overlay
          br_netfilter

    - path: /etc/sysctl.d/99-kubernetes.conf
      mode: 0644
      contents:
        inline: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1

    - path: /etc/containerd/config.toml
      mode: 0644
      contents:
        inline: |
          version = 2
          [plugins."io.containerd.grpc.v1.cri"]
            [plugins."io.containerd.grpc.v1.cri".containerd]
              [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
                [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
                  runtime_type = "io.containerd.runc.v2"
                  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
                    SystemdCgroup = true

    - path: /home/core/kubeadm-init.yaml
      mode: 0644
      contents:
        inline: |
          apiVersion: kubeadm.k8s.io/v1beta3
          kind: InitConfiguration
          bootstrapTokens:
            - token: "${KUBEADM_TOKEN}"
              ttl: "24h"
              usages:
                - signing
                - authentication
          nodeRegistration:
            criSocket: unix:///run/containerd/containerd.sock
            kubeletExtraArgs:
              cgroup-driver: systemd
          ---
          apiVersion: kubeadm.k8s.io/v1beta3
          kind: ClusterConfiguration
          kubernetesVersion: "${K8S_VERSION}"
          controlPlaneEndpoint: "${CONTROL_PLANE_VIP}:6443"
          etcd:
            local:
              dataDir: /var/lib/etcd
          networking:
            podSubnet: "${POD_SUBNET}"
            serviceSubnet: "${SERVICE_SUBNET}"
          ---
          apiVersion: kubelet.config.k8s.io/v1beta1
          kind: KubeletConfiguration
          cgroupDriver: systemd

    - path: /home/core/kubeadm-join-controller.yaml
      mode: 0644
      contents:
        inline: |
          apiVersion: kubeadm.k8s.io/v1beta3
          kind: JoinConfiguration
          discovery:
            bootstrapToken:
              apiServerEndpoint: "${CONTROL_PLANE_VIP}:6443"
              token: "${KUBEADM_TOKEN}"
              caCertHashes:
                - "sha256:REPLACE_WITH_CA_CERT_HASH"
          nodeRegistration:
            criSocket: unix:///run/containerd/containerd.sock
            kubeletExtraArgs:
              cgroup-driver: systemd
          controlPlane: {}

    # ── RBD kernel module for Rook-Ceph storage ──────────────────
    # Required on any node that mounts a Ceph RBD PersistentVolume.
    - path: /etc/modules-load.d/rbd.conf
      mode: 0644
      contents:
        inline: |
          rbd

    # ── Flatcar OS update server (Nebraska or public) ─────────────
    - path: /etc/flatcar/update.conf
      mode: 0644
      contents:
        inline: |
          SERVER=${FLATCAR_UPDATE_SERVER}
          GROUP=stable

systemd:
  units:
    - name: swap.target
      mask: true

    - name: systemd-sysctl.service
      enabled: true

    - name: containerd.service
      enabled: true

    - name: k8s-install.service
      enabled: true
      contents: |
        [Unit]
        Description=Install Kubernetes binaries
        After=network-online.target
        Wants=network-online.target
        ConditionPathExists=!/opt/bin/kubeadm

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/bin/bash -c '\
          K8S=${K8S_VERSION} && \
          mkdir -p /opt/bin && \
          curl -fsSLo /opt/bin/kubeadm https://dl.k8s.io/release/$${K8S}/bin/linux/amd64/kubeadm && \
          curl -fsSLo /opt/bin/kubelet https://dl.k8s.io/release/$${K8S}/bin/linux/amd64/kubelet && \
          curl -fsSLo /opt/bin/kubectl https://dl.k8s.io/release/$${K8S}/bin/linux/amd64/kubectl && \
          chmod +x /opt/bin/kubeadm /opt/bin/kubelet /opt/bin/kubectl'

        [Install]
        WantedBy=multi-user.target

    - name: kubelet.service
      enabled: true
      contents: |
        [Unit]
        Description=Kubernetes Kubelet
        After=containerd.service k8s-install.service
        Requires=containerd.service

        [Service]
        ExecStart=/opt/bin/kubelet \
          --container-runtime-endpoint=unix:///run/containerd/containerd.sock \
          --config=/var/lib/kubelet/config.yaml \
          --kubeconfig=/etc/kubernetes/kubelet.conf \
          --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf \
          --cgroup-driver=systemd
        Restart=always
        RestartSec=10

        [Install]
        WantedBy=multi-user.target
